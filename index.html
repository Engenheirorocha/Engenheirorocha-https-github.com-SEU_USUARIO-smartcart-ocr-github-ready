<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCart OCR</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script>
  <style>
    body {
      background: #f2f2f2;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    video, canvas {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    #produto-lista {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin-top: 20px;
    }
    .produto-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 10px;
      border-bottom: 1px solid #ddd;
    }
    #total {
      font-size: 1.5em;
      margin-top: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 10px;
      border: none;
      border-radius: 10px;
      margin: 5px;
      cursor: pointer;
    }
    .add {
      background: #4caf50;
      color: white;
    }
    .excluir {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <h1>SmartCart</h1>
  <video id="video" autoplay muted playsinline width="320" height="240"></video>
  <div id="produto-lista"></div>
  <div id="total">Total: R$ 0.00</div>

  <script>
    let total = 0;

    function atualizarTotal() {
      document.getElementById('total').innerText = `Total: R$ ${total.toFixed(2)}`;
    }

    function adicionarProduto(valor) {
      const lista = document.getElementById('produto-lista');
      const item = document.createElement('div');
      item.className = 'produto-item';

      const texto = document.createElement('span');
      texto.textContent = `Produto - R$ ${valor.toFixed(2)}`;

      const excluir = document.createElement('button');
      excluir.textContent = '❌';
      excluir.className = 'excluir';
      excluir.onclick = () => {
        lista.removeChild(item);
        total -= valor;
        atualizarTotal();
      };

      item.appendChild(texto);
      item.appendChild(excluir);
      lista.appendChild(item);

      total += valor;
      atualizarTotal();
    }

    function processarTexto(texto) {
      const regex = /\b\d{1,3},\d{2}\b/g;
      const encontrados = texto.match(regex);
      if (encontrados) {
        const validos = encontrados
          .map(v => parseFloat(v.replace(',', '.')))
          .filter(p => p >= 0.10 && p <= 999.99);

        if (validos.length > 0) {
          adicionarProduto(validos[0]); // adiciona o primeiro valor válido
        }
      }
    }

    async function capturarImagem(video) {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      return canvas;
    }

    async function iniciarOCR(video) {
      const canvas = await capturarImagem(video);
      const result = await Tesseract.recognize(canvas, 'por', {
        logger: m => console.log(m)
      });
      processarTexto(result.data.text);
    }

    async function iniciarCamera() {
      const video = document.getElementById('video');
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
      video.srcObject = stream;

      setInterval(() => iniciarOCR(video), 3000); // Captura a cada 3 segundos
    }

    iniciarCamera();
  </script>
</body>
</html>
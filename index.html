<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SmartCart OCR Único</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 90%; max-width: 500px; border-radius: 10px; }
    #cameraContainer { position: relative; display: inline-block; }
    #retangulo {
      position: absolute; top: 50%; left: 50%;
      width: 60%; height: 30%;
      transform: translate(-50%, -50%);
      border: 2px solid red; border-radius: 10px;
      pointer-events: none;
    }
    li {
      margin: 10px auto;
      padding: 12px;
      background: #eee;
      border-radius: 10px;
      max-width: 90%;
      font-size: 18px;
    }
    button {
      margin: 8px 10px;
      padding: 12px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button.excluir {
      background-color: #f44336;
    }
    button.excluir:hover {
      background-color: #d32f2f;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js">
function detectarMelhoresNomes(textoOCR) {
  const linhas = textoOCR.split('\n').map(l => l.trim()).filter(l => l.length > 2);
  const marcas = ['Italac', 'Sadia', 'Nestlé', 'Tio João', 'Ypê', 'Omo', 'Colgate', 'Perdigão'];
  const unidades = ['kg', 'g', 'ml', 'l', 'L', 'lt', 'un', 'pct', 'cx'];
  const palavrasBanidas = ['val', 'validade', 'promo', 'promoção', 'leve', 'pague', 'expira', 'data', 'desconto', 'oferta'];

  const categorias = {
    alimento: ['arroz', 'feijão', 'leite', 'macarrão', 'açúcar', 'óleo'],
    higiene: ['sabonete', 'shampoo', 'pasta', 'desodorante', 'creme'],
    limpeza: ['sabão', 'detergente', 'amaciante', 'veja'],
    bebida: ['cerveja', 'refrigerante', 'suco', 'água'],
  };

  const opcoes = [];

  for (const linhaOriginal of linhas) {
    let linha = linhaOriginal.toUpperCase();
    linha = linha.replace(/R\$O/g, 'R$ 0').replace(/VAL1DADE/g, 'VALIDADE').replace(/ARRO2/g, 'ARROZ');
    let pontos = 0;
    let categoria = 'outro';

    if (palavrasBanidas.some(p => linha.toLowerCase().includes(p))) continue;
    if (linha.split(' ').length >= 2) pontos += 1;
    if (linha === linha.toUpperCase()) pontos += 1;
    if (marcas.some(m => linha.includes(m.toUpperCase()))) pontos += 2;
    if (unidades.some(u => linha.toLowerCase().includes(u))) pontos += 1;

    for (const [cat, termos] of Object.entries(categorias)) {
      if (termos.some(t => linha.toLowerCase().includes(t))) {
        categoria = cat;
        pontos += 2;
      }
    }

    opcoes.push({ texto: linhaOriginal, pontos, categoria });
  }

  opcoes.sort((a, b) => b.pontos - a.pontos);
  return opcoes.slice(0, 3);
}

</script>
</head>
<body>
  <h1>SmartCart OCR Único</h1>
  <div id="cameraContainer">
    <video id="camera" autoplay playsinline></video>
    <div id="retangulo"></div>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <h3>Total: R$ <span id="total">0.00</span></h3>
  <ul id="lista"></ul>

  <script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const lista = document.getElementById("lista");
    const totalDisplay = document.getElementById("total");

    let total = 0;
    let lidos = [];
    let ocrAtivo = true;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("Erro: " + err));

    function capturaOCRPrecos() {
      if (!video.videoWidth || !ocrAtivo) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const rw = canvas.width * 0.6;
      const rh = canvas.height * 0.3;
      const rx = (canvas.width - rw) / 2;
      const ry = (canvas.height - rh) / 2;

      ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);

      ocrAtivo = false;

      Tesseract.recognize(canvas, 'por', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
          const regex = /(?:R\$|R\s*\$)?\s*(\d{1,3}(?:[\.,]\d{2})?)/gi;
          let precos = {};
          let match;
          while ((match = regex.exec(text)) !== null) {
            let preco = parseFloat(match[1].replace(',', '.'));
            if (!isNaN(preco)) {
              preco = parseFloat(preco.toFixed(2));
              precos[preco] = (precos[preco] || 0) + 1;
            }
          }
          const top = Object.entries(precos).sort((a,b)=>b[1]-a[1]);
          if (top.length > 0) {
            const preco = parseFloat(top[0][0]);
            if (!lidos.includes(preco)) {
              const li = document.createElement("li");
              const btnAdd = document.createElement("button");
              const btnDel = document.createElement("button");

              btnAdd.textContent = `✔️ Adicionar R$ ${preco.toFixed(2)}`;
              btnAdd.onclick = () => {
                total += preco;
                totalDisplay.textContent = total.toFixed(2);
                lidos.push(preco);
                li.remove();
                ocrAtivo = true;
              };

              btnDel.textContent = "❌ Excluir";
              btnDel.className = "excluir";
              btnDel.onclick = () => {
                li.remove();
                ocrAtivo = true;
              };

              li.appendChild(document.createTextNode("Produto detectado "));
              li.appendChild(btnAdd);
              li.appendChild(btnDel);
              lista.appendChild(li);
            } else {
              ocrAtivo = true;
            }
          } else {
            ocrAtivo = true;
          }
        })
        .catch(() => ocrAtivo = true);
    }

    setInterval(capturaOCRPrecos, 2000);
  
function detectarMelhoresNomes(textoOCR) {
  const linhas = textoOCR.split('\n').map(l => l.trim()).filter(l => l.length > 2);
  const marcas = ['Italac', 'Sadia', 'Nestlé', 'Tio João', 'Ypê', 'Omo', 'Colgate', 'Perdigão'];
  const unidades = ['kg', 'g', 'ml', 'l', 'L', 'lt', 'un', 'pct', 'cx'];
  const palavrasBanidas = ['val', 'validade', 'promo', 'promoção', 'leve', 'pague', 'expira', 'data', 'desconto', 'oferta'];

  const categorias = {
    alimento: ['arroz', 'feijão', 'leite', 'macarrão', 'açúcar', 'óleo'],
    higiene: ['sabonete', 'shampoo', 'pasta', 'desodorante', 'creme'],
    limpeza: ['sabão', 'detergente', 'amaciante', 'veja'],
    bebida: ['cerveja', 'refrigerante', 'suco', 'água'],
  };

  const opcoes = [];

  for (const linhaOriginal of linhas) {
    let linha = linhaOriginal.toUpperCase();
    linha = linha.replace(/R\$O/g, 'R$ 0').replace(/VAL1DADE/g, 'VALIDADE').replace(/ARRO2/g, 'ARROZ');
    let pontos = 0;
    let categoria = 'outro';

    if (palavrasBanidas.some(p => linha.toLowerCase().includes(p))) continue;
    if (linha.split(' ').length >= 2) pontos += 1;
    if (linha === linha.toUpperCase()) pontos += 1;
    if (marcas.some(m => linha.includes(m.toUpperCase()))) pontos += 2;
    if (unidades.some(u => linha.toLowerCase().includes(u))) pontos += 1;

    for (const [cat, termos] of Object.entries(categorias)) {
      if (termos.some(t => linha.toLowerCase().includes(t))) {
        categoria = cat;
        pontos += 2;
      }
    }

    opcoes.push({ texto: linhaOriginal, pontos, categoria });
  }

  opcoes.sort((a, b) => b.pontos - a.pontos);
  return opcoes.slice(0, 3);
}

</script>
</body>
</html>

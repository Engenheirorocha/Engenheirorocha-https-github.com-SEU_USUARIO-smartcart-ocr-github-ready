
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartCart OCR Firebase</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>SmartCart com Firebase</h1>
  <video id="video" autoplay playsinline width="320" height="240"></video>
  <script>
    const firebaseConfig = {'apiKey': 'AIzaSyAfhmfxYmQOgO3ACrCHeNZx83khMrDUD8U', 'authDomain': 'smartcart-app-dc796.firebaseapp.com', 'projectId': 'smartcart-app-dc796', 'storageBucket': 'smartcart-app-dc796.appspot.com', 'messagingSenderId': '903830223010', 'appId': '1:903830223010:web:9241e79644d2039c3e7ffb'};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const video = document.getElementById('video');
    let canvas = document.createElement('canvas');

    async function iniciarCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    }

    async function capturarImagemBase64() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      return canvas.toDataURL('image/jpeg', 0.6);
    }

    async function obterLocalizacao() {
      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(pos => {
          resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
        }, () => resolve({ lat: null, lng: null }));
      });
    }

    async function processarOCR() {
      const imagem = await capturarImagemBase64();
      const imageBlob = await (await fetch(imagem)).blob();
      const result = await Tesseract.recognize(imageBlob, 'eng');
      const texto = result.data.text;
      const match = texto.match(/\d{1,3}[.,]\d{2}/g);

      if (match) {
        const preco = parseFloat(match[0].replace(',', '.'));
        const local = await obterLocalizacao();
        const data = {
          preco: preco,
          imagem: imagem,
          dataHora: new Date().toISOString(),
          localizacao: local
        };
        await db.collection("leituras").add(data);
        console.log("Enviado:", data);
      }
    }

    iniciarCamera();
    setInterval(processarOCR, 5000); // A cada 5s
  </script>
</body>
</html>

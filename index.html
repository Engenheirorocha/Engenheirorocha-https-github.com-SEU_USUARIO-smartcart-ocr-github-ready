<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Cart</title>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --bg-grad: radial-gradient(1200px 600px at 10% 10%, #111a3b 0%, transparent 60%),
                 radial-gradient(900px 500px at 90% 20%, #0c2a3d 0%, transparent 55%),
                 radial-gradient(1100px 700px at 50% 120%, #1a1b32 0%, #0b1020 60%);
      --card: rgba(22,26,48,0.65);
      --card-2: rgba(15,19,38,0.65);
      --card-border: rgba(117,133,187,0.15);
      --text:#e7edff;
      --muted:#a9b4d0;
      --accent:#6ea8fe;
      --ok:#36d399;
      --warn:#f6c263;
      --err:#ff7c7c;
      --shadow: 0 10px 30px rgba(8,13,33,0.5), inset 0 1px rgba(255,255,255,0.05);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text);
      font: 500 15px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg); background-image: var(--bg-grad);
    }

    /* Header centrado com carrinho */
    header{
      position: sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(8,12,28,0.7), rgba(8,12,28,0.25));
      border-bottom: 1px solid var(--card-border);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; justify-content:center; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:34px; height:34px; border-radius:9px;
      background: linear-gradient(135deg, #6ea8fe, #36d399);
      box-shadow: 0 6px 18px rgba(110,168,254,0.35);
      display:grid; place-items:center;
    }
    .logo svg{ width:20px; height:20px; stroke:#ffffff; }
    h1{ font-size:18px; font-weight:700; margin:0; letter-spacing:.2px }

    /* Layout principal */
    main{
      max-width:1200px; margin:18px auto; padding:0 14px;
      display:grid; grid-template-columns:1.6fr 1fr; gap:16px;
    }
    @media (max-width:980px){ main{ grid-template-columns:1fr } }
    .card{
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .stack{ display:flex; flex-direction:column; gap:12px }

    /* C√¢mera */
    .videoWrap{
      position: relative; border-radius: 14px; overflow: hidden;
      border: 1px solid var(--card-border); background: rgba(0,0,0,0.35);
      aspect-ratio: 16/9; box-shadow: var(--shadow);
    }
    @media (max-width:980px){ .videoWrap{ aspect-ratio:auto; height:56vh } }
    video{ width:100%; height:100%; object-fit:cover; display:block; }
    #overlay{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    /* HUD */
    .hud{ position:absolute; left:10px; bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{
      background: rgba(12,18,40,0.7); border: 1px solid var(--card-border);
      color: var(--muted); padding: 6px 8px; font-size:12px; border-radius: 10px; backdrop-filter: blur(6px);
    }

    /* Coluna direita */
    .title{ font-size:13px; color:var(--muted); letter-spacing:.4px; text-transform:uppercase }
    #precos{ display:flex; flex-direction:column; gap:10px; max-height:48vh; overflow:auto; padding-right:4px; }
    .preco-btn{
      font-size:1.1em; font-weight:600; padding:12px 14px;
      background: linear-gradient(180deg, rgba(24,42,30,0.9), rgba(18,33,24,0.9));
      color:#d9ffe9; border:1px solid rgba(72,140,92,0.45); border-radius:12px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 6px 16px rgba(7,20,12,0.35);
    }
    .preco-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(7,20,12,0.45); border-color: rgba(72,140,92,0.7) }
    .preco-btn.pulse{ transform: scale(1.04) }

    /* Inputs/bot√µes */
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .input{
      border:1px solid var(--card-border); background: rgba(8,12,28,0.6);
      color:var(--text); padding: 10px 12px; border-radius:12px; outline:none;
    }
    .btn{
      border:1px solid var(--card-border); background: rgba(8,12,28,0.6);
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn.ok{ background: linear-gradient(180deg, rgba(16,36,28,0.9), rgba(14,30,24,0.9)); border-color: rgba(72,140,92,0.45) }
    .btn.warn{ background: linear-gradient(180deg, rgba(50,40,18,0.9), rgba(38,28,10,0.9)); border-color: rgba(181,148,75,0.45) }
    .btn.err{ background: linear-gradient(180deg, rgba(52,24,24,0.9), rgba(36,16,16,0.9)); border-color: rgba(164,74,74,0.45) }

    /* Total */
    #total{
      font-size: 1.8em; color:#c5f8d7; display:flex; align-items:center; justify-content:space-between;
      padding-top:8px; margin-top:6px; border-top:1px dashed var(--card-border);
    }

    /* Tip */
    .tip{ font-size:13px; color:var(--muted); border-left:3px solid rgba(110,168,254,0.5); padding-left:10px; }

    /* ===== Modal base ===== */
    .modal{
      position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
      background: rgba(5,8,20,0.6); backdrop-filter: blur(6px); z-index: 999;
    }
    .modal.show{ display:flex }
    .modal-card{
      width:min(900px, 94vw); background: var(--card); border: 1px solid var(--card-border);
      border-radius:16px; box-shadow: var(--shadow); padding: 0; display:flex; flex-direction:column; max-height:90vh;
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; border-bottom: 1px solid var(--card-border); background: var(--card-2);
    }
    .modal-title{ font-weight:700; letter-spacing:.3px }
    .modal-body{ overflow:auto; padding:14px; background: linear-gradient(180deg, rgba(10,14,30,0.4), rgba(10,14,30,0.2)); }
    .modal-foot{
      border-top:1px solid var(--card-border); padding:10px 12px; display:flex; gap:8px; align-items:center;
      background: var(--card-2); position:sticky; bottom:0;
    }

    /* Hist√≥rico */
    .hist{ display:flex; flex-direction:column; gap:8px; }
    .hist-item{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; border:1px solid var(--card-border); border-radius:12px; background: rgba(8,12,28,0.55);
    }
    .hist-left{ display:flex; align-items:center; gap:10px; }
    .pill{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--card-border); }
    .pill.add{ color:#d9ffe9; background: rgba(24,42,30,0.7); border-color: rgba(72,140,92,0.45) }
    .pill.sub{ color:#ffe0e0; background: rgba(52,24,24,0.6); border-color: rgba(164,74,74,0.45) }
    .hist-val{ font-weight:700 }
    .hist-time{ color: var(--muted); font-size:12px }

    /* ===== Chat estilo "feed" ===== */
    .feed{ display:flex; flex-direction:column; gap:16px; }
    .fb-card{
      border:1px solid var(--card-border); border-radius:14px; background: rgba(8,12,28,0.55);
      overflow:hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }
    .fb-header{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      background: linear-gradient(135deg, #6ea8fe, #36d399); display:grid; place-items:center; font-weight:800; color:#071122;
      border:1px solid rgba(255,255,255,0.15);
    }
    .author{ font-weight:700 }
    .time{ font-size:12px; color:var(--muted) }

    .fb-body{ padding:0 12px 12px 12px; display:flex; flex-direction:column; gap:8px; }
    .media{ width:100%; display:block; object-fit:cover; max-height:480px; }
    .price-badge{
      display:inline-flex; align-items:center; gap:6px; font-weight:800;
      background: rgba(16,36,28,0.9); color:#c5f8d7; border:1px solid rgba(72,140,92,0.45);
      padding:6px 10px; border-radius:999px; width:max-content;
    }
    .subtext{ font-size:12px; color:var(--muted) }

    .fb-actions{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px; border-top:1px solid var(--card-border); background: rgba(8,12,28,0.35);
    }
    .act-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .act{
      background: rgba(8,12,28,0.2); border:1px solid var(--card-border); color:var(--text);
      padding:8px 10px; border-radius:10px; cursor:pointer; transition:transform .12s ease, background .12s ease;
    }
    .act:hover{ transform: translateY(-1px) }
    .act.active{ outline: 2px solid rgba(110,168,254,0.35); }
    .act[disabled]{ opacity:.5; cursor:not-allowed }

    /* Mensagem em bolha */
    .msg-card{ padding:10px 12px 12px 12px; }
    .msg-line{ display:flex; align-items:flex-start; gap:10px; }
    .bubble{
      max-width: 80%; background: rgba(14,18,36,0.85); border:1px solid var(--card-border);
      padding:10px 12px; border-radius: 12px 12px 12px 4px;
    }
    .bubble.me{ background: rgba(24,42,30,0.85); border-color: rgba(72,140,92,0.45); border-radius:12px 12px 4px 12px; }
    .bubble .msg-text{ white-space:pre-wrap; }
    .bubble .msg-meta{ font-size:12px; color:var(--muted); margin-top:6px; }

    /* Input */
    .foot-input{
      flex:1; border:1px solid var(--card-border); background: rgba(8,12,28,0.6);
      color:var(--text); padding: 10px 12px; border-radius:999px; outline:none;
    }
    .foot-tog{ display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); user-select:none; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Carrinho de compras">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <h1>Smart Cart</h1>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- Esquerda: c√¢mera + HUD -->
    <section class="card stack">
      <div class="videoWrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
        <div class="hud">
          <span class="tag">Mire a etiqueta dentro do ret√¢ngulo (50% √ó 20%)</span>
        </div>
      </div>
      <div class="tip">A leitura ocorre automaticamente ~a cada 1,2s. Use a c√¢mera traseira e mantenha a etiqueta bem enquadrada.</div>
    </section>

    <!-- Direita: sugest√µes + controles + total -->
    <aside class="card stack">
      <div class="title">Sugest√µes de pre√ßo</div>
      <div id="precos"></div>

      <div class="row">
        <input id="manualInput" class="input" type="number" step="0.01" placeholder="Digite o valor (ex: 10.50)">
        <button class="btn ok" onclick="adicionarManual()">‚ûï Adicionar</button>
        <button class="btn warn" onclick="diminuirManual()">‚ûñ Diminuir</button>
        <button class="btn err" onclick="zerarTotal()">üßπ Zerar Total</button>
      </div>

      <div class="row">
        <button class="btn err" onclick="limparSugestoes()">‚ùå Apagar sugest√µes</button>
        <button class="btn warn" onclick="desfazerUltimo()">‚Ü©Ô∏è Desfazer √∫ltimo</button>
        <button class="btn" onclick="abrirHistorico(event)">üìú Hist√≥rico</button>
        <button class="btn" onclick="abrirFeed(event)">üí¨ Chat</button>
      </div>

      <div class="row" style="align-items:center">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
          <input type="checkbox" id="shareChatToggle" onchange="toggleShareChat(this.checked)">
          Enviar para o chat
        </label>
      </div>

      <div id="total">
        <span>Total</span>
        <span>R$ <span id="soma">0.00</span></span>
      </div>
    </aside>
  </main>

  <!-- Modal Hist√≥rico -->
  <div id="historicoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="histTitle">Hist√≥rico de lan√ßamentos</div>
        <div style="display:flex; gap:8px">
          <button class="btn warn" onclick="limparHistorico()">üßπ Limpar hist√≥rico</button>
          <button class="btn" onclick="fecharHistorico()">‚úñ Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="historicoLista" class="hist"></div>
      </div>
    </div>
  </div>

  <!-- Modal Chat/Feed -->
  <div id="feedModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="feedTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="feedTitle">Chat (timeline de pre√ßos)</div>
        <div style="display:flex; gap:8px">
          <button class="btn warn" onclick="limparFeed()">üßπ Limpar chat</button>
          <button class="btn" onclick="fecharFeed()">‚úñ Fechar</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="feedLista" class="feed"></div>
      </div>
      <div class="modal-foot">
        <input id="chatInput" class="foot-input" type="text" placeholder="Escreva uma mensagem..." />
        <label class="foot-tog">
          <input type="checkbox" id="chatLocToggle"> üìç incluir localiza√ß√£o
        </label>
        <button class="btn ok" onclick="enviarMensagem()">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bip-audio" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <!-- JS -->
  <script>
    /* ==== Cloud sync (Workers) ==== */
    const SYNC_TO_CLOUD = false; // true quando seu Worker estiver no ar
    const API_BASE = "https://smartcart-chat.SEU_SUBDOMINIO.workers.dev"; // troque pela sua URL

    // id √∫nico do aparelho (use o mesmo nos dois devices se quiser ver o mesmo feed)
    const DID_KEY = 'sc_device_id';
    let deviceId = localStorage.getItem(DID_KEY);
    if (!deviceId) {
      deviceId = Date.now() + '_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem(DID_KEY, deviceId);
    }

    /* ===== C√¢mera / elementos ===== */
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const precosDiv = document.getElementById('precos');
    const somaSpan = document.getElementById('soma');
    const bip = document.getElementById('bip-audio');

    /* ===== Hist√≥rico sess√£o ===== */
    const historico = []; // {tipo:'add'|'sub', valor, data, total}
    function registrar(tipo, valor){ historico.unshift({ tipo, valor, data: new Date(), total: total }); }

    let total = 0;
    let canvas = document.createElement('canvas');
    let isProcessing = false;
    let valoresAdicionados = [];
    let sugestoesFixas = false;

    // OCR cooldown
    let lastSuggestionsAt = 0;
    const SUGGESTIONS_COOLDOWN = 1200;

    // ROI
    const roi = { x:0, y:0, w:0, h:0 };

    function syncOverlayToVideo(){
      const rect = video.getBoundingClientRect();
      const dpr  = window.devicePixelRatio || 1;
      overlay.style.width  = rect.width + 'px';
      overlay.style.height = rect.height + 'px';
      overlay.width  = Math.round(rect.width  * dpr);
      overlay.height = Math.round(rect.height * dpr);
    }

    function desenharROI() {
      syncOverlayToVideo();
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      const w = overlay.width  * 0.5;
      const h = overlay.height * 0.2;
      const x = (overlay.width  - w) / 2;
      const y = (overlay.height - h) / 2;
      roi.x = x; roi.y = y; roi.w = w; roi.h = h;
      const dpr = window.devicePixelRatio || 1;
      ctx.strokeStyle = 'rgba(255,255,255,0.95)';
      ctx.lineWidth = 3 * dpr;
      ctx.shadowColor = 'rgba(110,168,254,0.65)';
      ctx.shadowBlur = 8 * dpr;
      ctx.strokeRect(x, y, w, h);
      ctx.shadowBlur = 0;
    }

    /* ===== Persist√™ncia local ===== */
    const LS_KEYS = { total: 'sc_total', valores: 'sc_valores', historico: 'sc_hist', feed: 'sc_feed', share: 'sc_share_chat' };

    function saveState(){
      localStorage.setItem(LS_KEYS.total, String(total));
      localStorage.setItem(LS_KEYS.valores, JSON.stringify(valoresAdicionados));
      const histJSON = historico.map(h => ({...h, data: h.data instanceof Date ? h.data.toISOString() : h.data}));
      localStorage.setItem(LS_KEYS.historico, JSON.stringify(histJSON));
      saveFeed();
    }

    function loadState(){
      const t = parseFloat(localStorage.getItem(LS_KEYS.total));
      total = Number.isFinite(t) && t >= 0 ? t : 0;

      try {
        const vals = JSON.parse(localStorage.getItem(LS_KEYS.valores) || '[]');
        valoresAdicionados = Array.isArray(vals) ? vals.filter(v => typeof v === 'number') : [];
      } catch { valoresAdicionados = []; }

      try {
        const hist = JSON.parse(localStorage.getItem(LS_KEYS.historico) || '[]');
        historico.length = 0;
        hist.forEach(h => historico.push({
          tipo: h.tipo === 'sub' ? 'sub' : 'add',
          valor: Number(h.valor) || 0,
          data: h.data ? new Date(h.data) : new Date(),
          total: Number(h.total) || 0
        }));
      } catch {}

      somaSpan.innerText = total.toFixed(2);
      loadFeed();
    }

    /* ===== Toggle "Enviar para o chat" ===== */
    let shareToChat = JSON.parse(localStorage.getItem(LS_KEYS.share) || 'false');
    function toggleShareChat(v){ shareToChat = !!v; localStorage.setItem(LS_KEYS.share, JSON.stringify(shareToChat)); }
    function initShareToggle(){ const el = document.getElementById('shareChatToggle'); if (el) el.checked = !!shareToChat; }
    function mapsRoute(lat, lng){ return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`; }

    /* ===== Controle OCR pausa/retoma ===== */
    let ocrPaused = false;
    function pauseOCR(v){ ocrPaused = !!v; }
    document.addEventListener('visibilitychange', ()=>{ pauseOCR(document.hidden); });

    /* ===== C√¢mera com fallback ===== */
    async function iniciarCamera() {
      const modos = [
        { video: { facingMode: { exact: 'environment' } }, audio: false },
        { video: { facingMode: { ideal: 'environment' } }, audio: false },
        { video: true, audio: false }
      ];
      let ok = false, lastErr = null;
      for (const opt of modos) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(opt);
          video.srcObject = stream;
          video.onloadedmetadata = () => { syncOverlayToVideo(); desenharROI(); };
          window.addEventListener('resize', syncOverlayToVideo);
          window.addEventListener('orientationchange', syncOverlayToVideo);
          ok = true; break;
        } catch (e) { lastErr = e; }
      }
      if (!ok) alert("Erro ao acessar a c√¢mera: " + (lastErr && lastErr.message ? lastErr.message : lastErr));
    }

    /* ===== Somat√≥rio ===== */
    function adicionarPreco(valor, btn) {
      total += valor;
      valoresAdicionados.push(valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      if (btn) { btn.classList.add('pulse'); setTimeout(()=>btn.classList.remove('pulse'), 300); }
      registrar('add', valor);
      saveState();
      capturarEEnviarImagem(valor);
    }

    function adicionarManual() {
      const input = document.getElementById('manualInput');
      const valor = parseFloat((input.value || '').replace(',', '.'));
      if (isNaN(valor) || valor <= 0) { alert("Digite um valor v√°lido."); input.value=''; input.focus(); return; }
      total += valor; valoresAdicionados.push(valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      registrar('add', valor);
      saveState();
      input.value=''; input.focus();
    }

    function diminuirManual() {
      const input = document.getElementById('manualInput');
      const valor = parseFloat((input.value || '').replace(',', '.'));
      if (isNaN(valor) || valor <= 0) { alert("Digite um valor v√°lido."); input.value=''; input.focus(); return; }
      total -= valor; if (total < 0) total = 0;
      valoresAdicionados.push(-valor);
      somaSpan.innerText = total.toFixed(2);
      limparSugestoes(); sugestoesFixas = false; bip.play();
      registrar('sub', valor);
      saveState();
      input.value=''; input.focus();
    }

    function zerarTotal() {
      total = 0; valoresAdicionados = [];
      somaSpan.innerText = total.toFixed(2); bip.play();
      historico.length = 0;
      localStorage.removeItem(LS_KEYS.total);
      localStorage.removeItem(LS_KEYS.valores);
      localStorage.removeItem(LS_KEYS.historico);
      saveFeed(); // n√£o apaga o chat
    }

    function desfazerUltimo() {
      if (valoresAdicionados.length > 0) {
        const valor = valoresAdicionados.pop();
        total -= valor; if (total < 0) total = 0;
        somaSpan.innerText = total.toFixed(2);
        saveState();
      }
    }

    function limparSugestoes() { precosDiv.innerHTML = ''; sugestoesFixas = false; }

    /* ===== Hist√≥rico UI ===== */
    function abrirHistorico(e){
      if (e) e.stopPropagation(); pauseOCR(true);
      const el = document.getElementById('historicoModal');
      const lista = document.getElementById('historicoLista');
      lista.innerHTML = '';
      if (historico.length === 0){
        const vazio = document.createElement('div');
        vazio.className = 'hist-item';
        vazio.innerHTML = '<span class="hist-val">Nenhum lan√ßamento ainda</span><span class="hist-time">‚Äî</span>';
        lista.appendChild(vazio);
      } else {
        historico.forEach(item => {
          const row = document.createElement('div');
          row.className = 'hist-item';
          const tipoPill = `<span class="pill ${item.tipo === 'add' ? 'add' : 'sub'}">${item.tipo === 'add' ? 'Adicionar' : 'Diminuir'}</span>`;
          const valorFmt = (item.tipo === 'add' ? '+' : '-') + ' R$ ' + item.valor.toFixed(2);
          const dateFmt = item.data instanceof Date ? item.data.toLocaleString('pt-BR') : new Date(item.data).toLocaleString('pt-BR');
          row.innerHTML = `
            <div class="hist-left">
              ${tipoPill}
              <span class="hist-val">${valorFmt}</span>
            </div>
            <div class="hist-right">
              <div class="hist-time">${dateFmt}</div>
              <div class="hist-time">Total ap√≥s: R$ ${item.total.toFixed(2)}</div>
            </div>
          `;
          lista.appendChild(row);
        });
      }
      el.classList.add('show');
    }
    function fecharHistorico(){ document.getElementById('historicoModal').classList.remove('show'); pauseOCR(false); }
    document.getElementById('historicoModal').addEventListener('click', (e)=>{ if (e.target.id==='historicoModal') fecharHistorico(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') { fecharHistorico(); fecharFeed(); } });

    /* ===== Utils Chat ===== */
    function shortName(id){ return (id && typeof id === 'string') ? 'ID ' + id.slice(-4) : 'Voc√™'; }
    function initials(name){ return (name||'V').trim().slice(0,2).toUpperCase(); }
    function timeAgo(iso){
      const d = new Date(iso); const s = Math.floor((Date.now() - d.getTime())/1000);
      if (s < 5) return 'agora';
      if (s < 60) return `${s}s`;
      const m = Math.floor(s/60); if (m < 60) return `${m} min`;
      const h = Math.floor(m/60); if (h < 24) return `${h} h`;
      return d.toLocaleString('pt-BR');
    }

    /* ===== OCR ===== */
    async function capturarImagemEProcessar() {
      if (ocrPaused || isProcessing || video.videoWidth === 0) return;
      isProcessing = true; desenharROI();
      const ctx = canvas.getContext('2d');

      const scaleX = video.videoWidth  / overlay.width;
      const scaleY = video.videoHeight / overlay.height;
      const roiWidth  = Math.round(roi.w * scaleX);
      const roiHeight = Math.round(roi.h * scaleY);
      const roiX      = Math.round(roi.x * scaleX);
      const roiY      = Math.round(roi.y * scaleY);

      const MAX_W = 600;
      let dw = roiWidth, dh = roiHeight;
      if (dw > MAX_W) { const s = MAX_W / dw; dw = Math.max(1, Math.round(dw*s)); dh = Math.max(1, Math.round(dh*s)); }
      canvas.width = dw; canvas.height = dh;

      if (ctx.filter !== undefined) ctx.filter = 'grayscale(1) contrast(115%)';
      ctx.drawImage(video, roiX, roiY, roiWidth, roiHeight, 0, 0, dw, dh);
      if (ctx.filter !== undefined) ctx.filter = 'none';

      try {
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
        const matches = text.match(/\d{1,3}(?:[.,]\d{2})/g);
        if (matches) {
          const now = Date.now();
          if (now - lastSuggestionsAt >= SUGGESTIONS_COOLDOWN) {
            lastSuggestionsAt = now;

            limparSugestoes();
            matches.slice(0, 3).forEach(str => {
              const valor = parseFloat(str.replace(',', '.'));
              if (!isNaN(valor) && valor > 0) {
                const btn = document.createElement('div');
                btn.className = 'preco-btn';
                btn.innerText = `R$ ${valor.toFixed(2)}`;
                btn.onclick = () => adicionarPreco(valor, btn);
                precosDiv.appendChild(btn);
              }
            });
          }
        }
      } catch (e) {
        console.warn('OCR erro:', e);
      } finally {
        isProcessing = false;
      }
    }

    /* ===== Chat/Feed (posts + mensagens) ===== */
    const FEED_LIMIT = 200;
    let feed = []; // it: {type:'post'|'msg', ...}

    function loadFeed(){
      try {
        const f = JSON.parse(localStorage.getItem(LS_KEYS.feed) || '[]');
        if (Array.isArray(f)) feed = f;
      } catch { feed = []; }
    }
    function saveFeed(){
      localStorage.setItem(LS_KEYS.feed, JSON.stringify(feed));
    }
    function pushFeed(item){
      feed.unshift(item);
      if (feed.length > FEED_LIMIT) feed.length = FEED_LIMIT;
      saveFeed();
    }

    async function abrirFeed(e){
      if (e) e.stopPropagation(); pauseOCR(true);

      // Atualiza dos posts + mensagens da nuvem (se ligado)
      if (SYNC_TO_CLOUD) {
        try {
          const res = await fetch(`${API_BASE}/api/feed?deviceId=${encodeURIComponent(deviceId)}`);
          const data = await res.json();
          if (data?.ok && Array.isArray(data.posts)) {
            const posts = data.posts.map(p => ({
              type:'post', id: p.id, ts: p.ts, valor: p.valor, img: p.img, coords: p.coords,
              rating: p.rating || 0, status: p.status || 'pending', valid: p.valid || {yes:0,no:0},
              author: p.deviceId
            }));
            let messages = [];
            try {
              const mres = await fetch(`${API_BASE}/api/messages?deviceId=${encodeURIComponent(deviceId)}`);
              const mdata = await mres.json();
              if (mdata?.ok && Array.isArray(mdata.messages)) {
                messages = mdata.messages.map(m => ({ type:'msg', id: m.id, ts: m.ts, text: m.text, coords: m.coords, author: m.deviceId }));
              }
            } catch {}
            const localMsgs = feed.filter(it => it.type==='msg' && !messages.some(m=>m.id===it.id));
            feed = [...posts, ...messages, ...localMsgs].sort((a,b)=> new Date(b.ts) - new Date(a.ts));
            if (feed.length > FEED_LIMIT) feed.length = FEED_LIMIT;
            saveFeed();
          }
        } catch(e){ console.warn('cloud feed erro:', e); }
      }

      renderFeed();
      document.getElementById('feedModal').classList.add('show');

      const ci = document.getElementById('chatInput');
      if (ci) { ci.focus(); ci.addEventListener('keydown', onChatKey); }
    }
    function fecharFeed(){
      document.getElementById('feedModal').classList.remove('show'); pauseOCR(false);
      const ci = document.getElementById('chatInput');
      if (ci) ci.removeEventListener('keydown', onChatKey);
    }
    function onChatKey(e){ if (e.key === 'Enter') enviarMensagem(); }

    function renderFeed(){
      const lista = document.getElementById('feedLista');
      lista.innerHTML = '';

      const items = [...feed].sort((a,b)=> new Date(b.ts) - new Date(a.ts));
      if (!items.length){
        const empty = document.createElement('div');
        empty.className = 'hist-item';
        empty.textContent = 'Seu chat est√° vazio. Ative ‚ÄúEnviar para o chat‚Äù ou escreva uma mensagem abaixo.';
        lista.appendChild(empty);
        return;
      }

      items.forEach(p=>{
        const isMe = (p.author ? p.author === deviceId : true);
        const name = isMe ? 'Voc√™' : shortName(p.author);
        const avatarText = initials(name);

        if (p.type === 'msg'){
          const card = document.createElement('div'); card.className = 'fb-card msg-card';
          const line = document.createElement('div'); line.className = 'msg-line';

          const av = document.createElement('div'); av.className='avatar'; av.textContent = avatarText;

          const bubble = document.createElement('div'); bubble.className = 'bubble' + (isMe ? ' me' : '');
          const text = document.createElement('div'); text.className = 'msg-text'; text.textContent = p.text || '';
          const meta = document.createElement('div'); meta.className = 'msg-meta';
          meta.textContent = `${name} ¬∑ ${timeAgo(p.ts)}${p.coords ? ' ¬∑ com localiza√ß√£o' : ''}`;

          bubble.appendChild(text); bubble.appendChild(meta);

          if (isMe){ // eu √† direita (estilo chat)
            line.style.justifyContent = 'flex-end';
            line.appendChild(bubble); line.appendChild(av);
          } else {
            line.appendChild(av); line.appendChild(bubble);
          }

          card.appendChild(line);
          lista.appendChild(card);
        } else {
          // Post (foto + pre√ßo) estilo card de feed
          const card = document.createElement('div'); card.className = 'fb-card';

          // header
          const head = document.createElement('div'); head.className = 'fb-header';
          const av = document.createElement('div'); av.className='avatar'; av.textContent = avatarText;
          const info = document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column';
          const nm = document.createElement('div'); nm.className='author'; nm.textContent = name;
          const tm = document.createElement('div'); tm.className='time';
          tm.textContent = `${timeAgo(p.ts)}${p.coords ? ' ¬∑ com localiza√ß√£o' : ''}`;
          info.appendChild(nm); info.appendChild(tm);
          head.appendChild(av); head.appendChild(info);
          card.appendChild(head);

          // media
          if (p.img){
            const img = document.createElement('img'); img.className='media'; img.src = p.img; img.alt = `Pre√ßo: R$ ${Number(p.valor).toFixed(2)}`;
            card.appendChild(img);
          }

          // body
          const body = document.createElement('div'); body.className='fb-body';
          const price = document.createElement('div'); price.className='price-badge';
          price.textContent = 'R$ ' + Number(p.valor).toFixed(2);
          const badge = document.createElement('div'); badge.className='subtext';
          if (p.status === 'confirmed') badge.textContent = `‚úî Validado por ${p.valid?.yes||0}`;
          else if (p.status === 'rejected') badge.textContent = `‚ö† Reprovado (${p.valid?.no||0})`;
          else badge.textContent = `‚è≥ Aguardando valida√ß√£o`;
          body.appendChild(price);
          body.appendChild(badge);
          card.appendChild(body);

          // actions
          const actions = document.createElement('div'); actions.className='fb-actions';
          const left = document.createElement('div'); left.className='act-row';
          const right = document.createElement('div'); right.className='act-row';

          const btnOk = document.createElement('button'); btnOk.className='act' + (p.rating === 1 ? ' active' : ''); btnOk.textContent='üëç Bom';
          btnOk.onclick = ()=> setRating(p.id, 1);
          const btnBad = document.createElement('button'); btnBad.className='act' + (p.rating === -1 ? ' active' : ''); btnBad.textContent='üëé Ruim';
          btnBad.onclick = ()=> setRating(p.id, -1);

          left.appendChild(btnOk); left.appendChild(btnBad);

          const btnMap = document.createElement('button'); btnMap.className='act'; btnMap.textContent='üìç Rota';
          if (p.coords){ btnMap.onclick = ()=> window.open(mapsRoute(p.coords.lat, p.coords.lng), '_blank'); }
          else { btnMap.disabled = true; }
          const btnShare = document.createElement('button'); btnShare.className='act'; btnShare.textContent='üîó Compartilhar';
          btnShare.onclick = ()=> sharePost(p);
          right.appendChild(btnMap); right.appendChild(btnShare);

          actions.appendChild(left); actions.appendChild(right);
          card.appendChild(actions);

          lista.appendChild(card);
        }
      });
    }

    function sharePost(p){
      const text = `Oferta: R$ ${Number(p.valor).toFixed(2)}${p.coords ? `\nMapa: ${mapsRoute(p.coords.lat, p.coords.lng)}` : ''}`;
      try{
        if (navigator.share){
          navigator.share({ text, title: 'Smart Cart', url: p.coords ? mapsRoute(p.coords.lat, p.coords.lng) : undefined });
        } else {
          const url = 'https://wa.me/?text=' + encodeURIComponent(text);
          window.open(url, '_blank');
        }
      }catch(e){ console.warn('share erro:', e); }
    }
    function shareMessage(p){
      const text = `${p.text}${p.coords ? `\nMapa: ${mapsRoute(p.coords.lat, p.coords.lng)}` : ''}`;
      try{
        if (navigator.share){
          navigator.share({ text, title: 'Smart Cart' });
        } else {
          const url = 'https://wa.me/?text=' + encodeURIComponent(text);
          window.open(url, '_blank');
        }
      }catch(e){ console.warn('share erro:', e); }
    }

    function setRating(id, v){
      const idx = feed.findIndex(p=>p.type==='post' && p.id===id);
      if (idx === -1) return;
      // alterna: se j√° est√°, zera
      feed[idx].rating = (feed[idx].rating === v) ? 0 : v;
      saveFeed();
      renderFeed();

      if (SYNC_TO_CLOUD) {
        fetch(`${API_BASE}/api/rating`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ deviceId, id, rating: feed[idx].rating })
        }).catch(e=>console.warn('cloud rating erro:', e));
      }
    }

    /* ===== Enviar mensagem de texto (com sync) ===== */
    async function enviarMensagem(){
      const input = document.getElementById('chatInput');
      let text = (input.value || '').trim();
      if (!text) { input.focus(); return; }
      const wantLoc = document.getElementById('chatLocToggle').checked;

      const pushLocal = (coords, id=null, ts=null) => {
        const item = { type:'msg', id: id || (Date.now() + '_' + Math.random().toString(36).slice(2,7)), ts: ts || new Date().toISOString(), text, coords: coords || null, author: deviceId };
        pushFeed(item); renderFeed(); input.value=''; input.focus();
      };

      if (SYNC_TO_CLOUD) {
        let coords = null;
        if (wantLoc && navigator.geolocation){
          try {
            const pos = await new Promise((res, rej)=> navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:7000 }));
            coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          } catch {}
        }
        try{
          const res = await fetch(`${API_BASE}/api/message`, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ deviceId, text, coords })
          });
          const data = await res.json();
          if (data?.ok && data.message){
            pushLocal(data.message.coords || null, data.message.id, data.message.ts);
            return;
          }
        }catch(e){ console.warn('cloud msg erro:', e); }
        pushLocal(coords || null); // fallback local
      } else {
        if (wantLoc && navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            pos => pushLocal({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            ()  => pushLocal(null),
            { enableHighAccuracy:true, timeout:7000 }
          );
        } else pushLocal(null);
      }
    }

    /* ===== Limpar chat ===== */
    function limparFeed(){
      if (!confirm('Limpar todo o chat?')) return;
      feed = [];
      saveFeed();
      renderFeed();
    }

    /* ===== Captura foto + envia para chat (post) ===== */
    async function capturarEEnviarImagem(valor) {
      try {
        const fullCanvas = document.createElement('canvas');
        fullCanvas.width = video.videoWidth;
        fullCanvas.height = video.videoHeight;
        fullCanvas.getContext('2d').drawImage(video, 0, 0);
        const maxW = 640;
        let tw = fullCanvas.width, th = fullCanvas.height;
        if (tw > maxW){ const s = maxW / tw; tw = Math.max(1, Math.round(tw*s)); th = Math.max(1, Math.round(th*s)); }
        const thumb = document.createElement('canvas');
        thumb.width = tw; thumb.height = th;
        thumb.getContext('2d').drawImage(fullCanvas, 0, 0, tw, th);
        const imageThumb = thumb.toDataURL('image/jpeg', 0.7);

        if (shareToChat) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            const coords = { lat: position.coords.latitude, lng: position.coords.longitude };

            // chat local
            pushFeed({ type:'post', id: Date.now() + '_' + Math.random().toString(36).slice(2,7),
                       ts: new Date().toISOString(), valor: +valor, img: imageThumb, coords, rating: 0,
                       status:'pending', valid:{yes:0,no:0}, author: deviceId });

            // nuvem (opcional)
            if (SYNC_TO_CLOUD) {
              try {
                await fetch(`${API_BASE}/api/post`, {
                  method: 'POST',
                  headers: { 'Content-Type':'application/json' },
                  body: JSON.stringify({ deviceId, valor:+valor, coords, imageData:imageThumb })
                });
              } catch(e){ console.warn('cloud post erro:', e); }
            }
          }, async () => {
            pushFeed({ type:'post', id: Date.now() + '_' + Math.random().toString(36).slice(2,7),
                       ts: new Date().toISOString(), valor: +valor, img: imageThumb, coords: null, rating: 0,
                       status:'pending', valid:{yes:0,no:0}, author: deviceId });

            if (SYNC_TO_CLOUD) {
              try {
                await fetch(`${API_BASE}/api/post`, {
                  method: 'POST',
                  headers: { 'Content-Type':'application/json' },
                  body: JSON.stringify({ deviceId, valor:+valor, coords:null, imageData:imageThumb })
                });
              } catch(e){ console.warn('cloud post erro:', e); }
            }
          });
        }
      } catch (e) {
        console.warn('snapshot/geo erro:', e);
      }
    }

    // ===== Inicializa√ß√£o =====
    setInterval(capturarImagemEProcessar, 1200);
    iniciarCamera();
    loadState();
    initShareToggle();
  </script>
</body>
</html>



